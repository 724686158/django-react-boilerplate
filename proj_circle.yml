machine:  # remeber to update those!
  python:
    version: 3.6.0
  node:
    version: 6.1.0

test:
  override:
    - npm install
    - npm run build
    # style check
    - prospector
    # security checks
    - bandit -r .
    - cat requirements.txt | safety check --stdin
    # imports check
    - isort **/*.py --check-only
    # pre-commit additional checks
    - SKIP=prospector,isort pre-commit run --all-files
    - >
        DJANGO_SETTINGS_MODULE={{project_name}}.settings.local
            python manage.py has_missing_migrations --ignore authtools;
    - >
        SECRET_KEY=$(python -c 'import uuid; print(uuid.uuid4().hex + uuid.uuid4().hex)')
        DATABASE_URL='sqlite:///'
        ALLOWED_HOSTS='.example.org'
        SENDGRID_USERNAME='test'
        SENDGRID_PASSWORD='test'
        REDIS_URL='redis://'
            python manage.py check --deploy --settings={{project_name}}.settings.production
    - coverage run manage.py test
    - npm run lint
  post:
    - coverage html -d $CIRCLE_ARTIFACTS

deployment:
  staging:
    branch: develop
    commands:
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - git push git@heroku.com:{{project_name}}staging.git $CIRCLE_SHA1:refs/heads/master

  production:
    branch: master
    commands:
      - "[[ ! -s \"$(git rev-parse --git-dir)/shallow\" ]] || git fetch --unshallow"
      - heroku pg:backups capture -a {{project_name}}-production
      - git push git@heroku.{{project_name}}-production.git $CIRCLE_SHA1:refs/heads/master

# This is necessary for the boilerplate's CI. You can remove these lines
general:
  branches:
    ignore:
      - boilerplate-release
